# Архитектура и слои

## 1) Данные

**Импорт** создаёт версионный *снимок* данных, помечая строки `import_run_id`.  
Ручные записи (`import_run_id = NULL`) **не удаляются** и включаются в отчёты.

### Основные таблицы
- `baseline_volume` — «Защита» (плановая ведомость из ВДЦ)
- `fact_volume_daily` — факты по дням (распаковка датных колонок ВДЦ)
- `plan_volume_monthly` — план по месяцам (ГПР → распределение по дням → агрегация)
- `fact_resource_daily` — люди/техника по дням
- `fact_pnl_monthly` — БДР по месяцам
- `fact_cashflow_monthly` — БДДС по месяцам
- `operation`, `wbs`, `resource`, `fin_account` — справочники
- `import_run` — версия импорта
- `operation_dependency` — зависимости операций (Гант)

## 2) ETL

`services/etl/importer.py`:
1) Очистить строки текущей версии (import_run_id)
2) Спарсить листы:
   - `ВДЦ` → baseline + daily fact
   - `ГПР` → операции + плановые количества
   - `Люди техника` → daily resource
   - `БДР` / `БДДС` → monthly finance
3) Upsert справочников
4) Insert/Upsert фактов
5) Записать ошибки в `import_error`

## 3) Отчёты

`services/reports/service.py`:
- KPI (факт, план, прогресс, manhours, производительность)
- План/Факт серия (day/week/month)
- План/Факт таблица (by discipline/wbs/...)
- БДР и БДДС
- Отчёты поддерживают `import_run_id` для работы с версиями

## 4) UI

Next.js:
- Главная: KPI + график План/Факт
- Прогресс: таблица отклонений
- БДР, БДДС: таблица/график
- Импорт: загрузка файла и статусы
- ГПР: Гант, зависимости, критический путь
